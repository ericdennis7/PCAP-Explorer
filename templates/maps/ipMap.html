<script> // ipMap
    document.addEventListener("DOMContentLoaded", function () {
        // Parse ipMapData
        const ipMapData = {{ file_info['unique_ips']['top_ips'] | tojson | safe }};
        
        // Process map data
        const mapData = Object.keys(ipMapData).map(ip => {
            const loc = ipMapData[ip].loc;
            if (!loc || loc.trim() === '') {
                return null;
            }
        
            const coords = loc.split(',').map(parseFloat);
            if (coords.length !== 2 || isNaN(coords[0]) || isNaN(coords[1])) {
                return null;
            }
        
            const [latitude, longitude] = coords;
        
            return {
                rank: ipMapData[ip].rank,
                title: ip,
                latitude: latitude,
                longitude: longitude,
                country: ipMapData[ip].country,
                count: ipMapData[ip].count,
                org: ipMapData[ip].org,
                hostname: ipMapData[ip].hostname,
                location: ipMapData[ip].location,
                timezone: ipMapData[ip].timezone,
                percentage: parseFloat(ipMapData[ip].percentage.toFixed(2))
            };
        }).filter(data => data !== null);

        // If no valid data is available, don't proceed
        if (mapData.length === 0) {
            console.error("No valid map data to display.");
            return;
        }

        // Ensure necessary libraries are loaded
        if (typeof am5 === 'undefined' || typeof am5map === 'undefined' || typeof am5themes_Animated === 'undefined') {
            console.error('AmCharts libraries are not loaded');
            return;
        }

        // Create root element
        const root = am5.Root.new("ipMap");
        
        // Set themes
        root.setThemes([am5themes_Animated.new(root)]);
        
        // Create the map chart
        const chart = root.container.children.push(
            am5map.MapChart.new(root, {
                projection: am5map.geoNaturalEarth1(),
                panX: "translateX",
                panY: "translateY",
                paddingBottom: 10,
                paddingTop: 10,
                paddingLeft: 10,
                paddingRight: 10
            })
        );
        
        // Add a polygon series for the world map
        const polygonSeries = chart.series.push(
            am5map.MapPolygonSeries.new(root, {
                geoJSON: am5geodata_worldLow,
                exclude: ["AQ"]
            })
        );

        // Style the world map polygons
        polygonSeries.mapPolygons.template.setAll({
            tooltipText: "{name}", 
            stroke: am5.color(0x888888), 
            strokeWidth: 1, 
        });

        // Extract unique country codes from mapData
        let uniqueCountries = new Set(mapData.map(item => item.country));

        // Update polygon colors based on detected countries
        polygonSeries.mapPolygons.template.adapters.add("fill", (fill, target) => {
            let countryId = target.dataItem.dataContext.id;
            if (uniqueCountries.has(countryId)) {
                return am5.color(0x54478C);
            }
            return fill;
        });

        // Add hover effect for the world map
        polygonSeries.mapPolygons.template.states.create("hover", {
            fill: am5.color(0x54478C), 
        });

        // Add a polygon series for US states
        const usPolygonSeries = chart.series.push(
            am5map.MapPolygonSeries.new(root, {
                geoJSON: am5geodata_usaLow,
            })
        );

        // Style the US states
        usPolygonSeries.mapPolygons.template.setAll({
            tooltipText: "{name}", 
            fill: am5.color(0x282828), 
            stroke: am5.color(0x888888), 
            strokeWidth: 1,
        });

        // Modify US states fill color if US is in uniqueCountries
        if (uniqueCountries.has("US")) {
            usPolygonSeries.mapPolygons.template.adapters.add("fill", (fill, target) => {
                return am5.color(0x54478C);
            });
        }
        
        chart.set("zoomLevel", 1);
        
        // Create clustered point series for IP locations
        var pointSeries = chart.series.push(am5map.ClusteredPointSeries.new(root, {}));

        // Set clustered bullet
        pointSeries.set("clusteredBullet", function(root) {
            var container = am5.Container.new(root, {
                cursorOverStyle: "pointer"
            });

            var circle1 = container.children.push(am5.Circle.new(root, {
                radius: 12,
                tooltipY: 0,
                fill: am5.color(0x2C699A) 
            }));

            var circle2 = container.children.push(am5.Circle.new(root, {
                radius: 16,
                fillOpacity: 0.3,
                tooltipY: 0,
                fill: am5.color(0x2C699A)
            }));

            var circle3 = container.children.push(am5.Circle.new(root, {
                radius: 20,
                fillOpacity: 0.3,
                tooltipY: 0,
                fill: am5.color(0x2C699A)
            }));

            var label = container.children.push(am5.Label.new(root, {
                centerX: am5.p50,
                centerY: am5.p50,
                fill: am5.color(0xffffff),
                populateText: true,
                fontSize: "12",
                text: "{value}"
            }));

            container.events.on("click", function(e) {
                pointSeries.zoomToCluster(e.target.dataItem);
            });

            return am5.Bullet.new(root, { sprite: container });
        });

        // Create individual bullets (for single points)
        pointSeries.bullets.push(function() {
            var circle = am5.Circle.new(root, {
                radius: 6,
                tooltipY: 0,
                fill: am5.color(0x16DB93), 
                stroke: am5.color(0xffffff),
                strokeWidth: 2,
                tooltipText: "IP: {title}\nPackets: {count}\nRank: {rank}\nLocation: {location}"
            });

            return am5.Bullet.new(root, { sprite: circle });
        });

        // Set the point series data
        pointSeries.data.setAll(mapData.map(item => ({
            title: item.title,
            latitude: item.latitude,
            longitude: item.longitude,
            country: item.country,
            count: item.count,
            org: item.org,
            hostname: item.hostname,
            location: item.location,
            timezone: item.timezone,
            percentage: item.percentage,
            rank: item.rank,
            geometry: {
                type: "Point",
                coordinates: [item.longitude, item.latitude]
            }
        })));

        let polygonTemplate = polygonSeries.mapPolygons.template;
            polygonTemplate.setAll({
                tooltipText: "{name}",
                toggleKey: "active",
                interactive: true,
                fill: am5.color(0x282828),
            });
    
        polygonTemplate.states.create("hover", {
            fill: am5.color(0x54478C)
        });

        zoomControl = chart.set("zoomControl", am5map.ZoomControl.new(root, {
            layout: root.horizontalLayout  // Arrange controls horizontally
        }));
        
        zoomControl.homeButton.set("visible", true);
        
        // Move zoom control to the top-left
        zoomControl.setAll({
            x: 50,  // Move to the left
            y: 125,  // Move to the top
        });
                            
        
        backgroundSeries.mapPolygons.template.setAll({
            fill: am5.color(0x3f3f3f),
            stroke: am5.color(0x3f3f3f),
        });

        root._logo.dispose();
        
        // Make the chart responsive
        chart.appear(1000, 100);
    });
</script>