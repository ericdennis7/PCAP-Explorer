<script>
    window.onload = function () {
        am5.ready(function () {
            let root = am5.Root.new("convMap");
    
            root.setThemes([]);
    
            let chart = root.container.children.push(
                am5map.MapChart.new(root, {
                    panX: "translateX",
                    panY: "translateY",
                    projection: am5map.geoNaturalEarth1()
                })
            );
    
            chart.set("zoomLevel", 1);
    
            // Background world map
            let polygonSeries = chart.series.push(
                am5map.MapPolygonSeries.new(root, {
                    geoJSON: am5geodata_worldLow,
                    exclude: ["AQ"]
                })
            );
    
            polygonSeries.mapPolygons.template.setAll({
                tooltipText: "{name}",
                interactive: true,
                fill: am5.color(0x282828),
                stroke: am5.color(0x888888),
                strokeWidth: 1
            });
    
            polygonSeries.states.create("hover", {
                fill: am5.color(0x54478C)
            });
    
            let graticuleSeries = chart.series.push(am5map.GraticuleSeries.new(root, {}));
            graticuleSeries.mapLines.template.setAll({
                stroke: root.interfaceColors.get("alternativeBackground"),
                strokeOpacity: 0.08
            });
    
            let lineSeries = chart.series.push(am5map.MapLineSeries.new(root, {}));
            lineSeries.mapLines.template.setAll({
                stroke: am5.color(0x818589),
                strokeOpacity: 1,
                strokeWidth: 2,
                strokeDasharray: [5, 3]
            });
    
            let pointSeries = chart.series.push(am5map.MapPointSeries.new(root, {
                clustered: true
            }));
    
            // Optimized clustered bullet with only ONE circle instead of three
            pointSeries.set("clusteredBullet", function (root) {
                let container = am5.Container.new(root, {
                    cursorOverStyle: "pointer"
                });
    
                let circle = container.children.push(am5.Circle.new(root, {
                    radius: 12,
                    fill: am5.color(0x2C699A)
                }));
    
                let label = container.children.push(am5.Label.new(root, {
                    centerX: am5.p50,
                    centerY: am5.p50,
                    fill: am5.color(0xffffff),
                    fontSize: "12",
                    text: "{value}"
                }));
    
                container.events.on("click", function (e) {
                    pointSeries.zoomToCluster(e.target.dataItem);
                });
    
                return am5.Bullet.new(root, { sprite: container });
            });
    
            // Load data from Flask
            let conversations;
            try {
                conversations = JSON.parse('{{ file_info["top_conversations"] | tojson | safe }}');
                console.log(conversations);
            } catch (error) {
                console.error("Error parsing JSON:", error);
                return;
            }
    
            if (!Array.isArray(conversations) || conversations.length === 0) {
                console.error("No valid conversation data found.");
                return;
            }
    
            let uniqueLocations = new Set();
    
            conversations.forEach(conv => {
                if (conv["IP A Loc"] && conv["IP B Loc"]) {
                    let locA = conv["IP A Loc"].split(",").map(Number);
                    let locB = conv["IP B Loc"].split(",").map(Number);
    
                    let locACorrected = [locA[1], locA[0]];
                    let locBCorrected = [locB[1], locB[0]];
    
                    // Add lines once
                    lineSeries.pushDataItem({
                        geometry: {
                            type: "LineString",
                            coordinates: [locACorrected, locBCorrected]
                        }
                    });
    
                    // Avoid duplicate points
                    let keyA = locACorrected.join(",");
                    let keyB = locBCorrected.join(",");
    
                    if (!uniqueLocations.has(keyA)) {
                        uniqueLocations.add(keyA);
                        pointSeries.pushDataItem({
                            title: conv["IP A"],
                            packets: conv["Packets"],
                            protocol: conv["Protocol"],
                            country: conv["IP A Country"],
                            geometry: {
                                type: "Point",
                                coordinates: locACorrected
                            }
                        });
                    }
    
                    if (!uniqueLocations.has(keyB)) {
                        uniqueLocations.add(keyB);
                        pointSeries.pushDataItem({
                            title: conv["IP B"],
                            packets: conv["Packets"],
                            protocol: conv["Protocol"],
                            country: conv["IP B Country"],
                            geometry: {
                                type: "Point",
                                coordinates: locBCorrected
                            }
                        });
                    }
                } else {
                    console.warn("Skipping entry due to missing location data:", conv);
                }
            });
    
            // Bullet with optimized tooltip
            pointSeries.bullets.push(function(root, series, dataItem) {
                let circle = am5.Circle.new(root, {
                    radius: 6,
                    tooltipY: 0,
                    fill: am5.color(0x16DB93),
                    stroke: am5.color(0xffffff),
                    strokeWidth: 2
                });
    
                let tooltipText = "IP: {title} (Country: {country})\nPackets: {packets}\nProtocol: {protocol}";
                circle.set("tooltipText", tooltipText);
    
                return am5.Bullet.new(root, { sprite: circle });
            });
    
            // Remove unnecessary background styling
            let backgroundSeries = chart.series.unshift(
                am5map.MapPolygonSeries.new(root, {})
            );
            backgroundSeries.mapPolygons.template.setAll({
                fill: am5.color(0x3f3f3f),
                stroke: am5.color(0x3f3f3f)
            });
    
            // Remove unnecessary US states map layer
            // If you truly need it, make sure it's conditionally loaded
    
            let zoomControl = chart.set("zoomControl", am5map.ZoomControl.new(root, {
                layout: root.horizontalLayout
            }));
    
            zoomControl.homeButton.set("visible", true);
            zoomControl.setAll({
                x: 50,
                y: 125
            });
    
            chart.appear(1000, 100);
            root._logo.dispose(); // Removes amCharts watermark
        });
    };
    </script>
    