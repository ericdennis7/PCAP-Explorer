<script>
    // Initialize Leaflet convMap with minimum zoom
    const convMap = L.map('convMap', {
        center: [45, 0],
        zoom: 2,
        minZoom: 2
    });
    
    // Set boundaries to focus on
    convMap.setMaxBounds(L.latLngBounds(L.latLng(-60, -180), L.latLng(90, 180)));
    
    // Dark-themed tile layer (CartoDB Dark Matter)
    L.tileLayer('https://tile.jawg.io/jawg-dark/{z}/{x}/{y}{r}.png?access-token=AmpvthQfCvrciGf9uwOxVxLJtBM5tAPzFQku70CODOsifZEhI5yTk2hpQ9zFwRb3', {
        attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 20,
        noWrap: true
    }).addTo(convMap);
    
    // Initialize marker cluster group with a smaller cluster radius
    const markers = L.markerClusterGroup({
        maxClusterRadius: 20,
        disableClusteringAtZoom: 10
    });

    convMap.locate({
        enableHighAccuracy: true,
    })
    // if location found show marker and circle
    .on("locationfound", (e) => {
        console.log(e);
    
        // Custom marker icon
        const customIcon = L.icon({
            iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png", // Change this URL for different colors
            shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
    
        // marker with custom icon
        const marker = L.marker([e.latitude, e.longitude], { icon: customIcon }).bindPopup(
            "You're Here :)"
        );
    
        map.addLayer(marker);
    })
    
    // if error show alert
    .on("locationerror", (e) => {
        console.log(e);
        alert("Location access denied.");
    });
    
    // Sample data (Replace with Flask-generated JSON)
    let conversations = JSON.parse('{{ file_info["top_conversations"] | tojson | safe }}');
    
    let uniqueLocations = new Set();
    
    conversations.forEach(conv => {
        if (conv["IP A Loc"] && conv["IP B Loc"]) {
            let locA = conv["IP A Loc"].split(",").map(Number);
            let locB = conv["IP B Loc"].split(",").map(Number);
    
            let locACorrected = [locA[0], locA[1]]; // Leaflet uses [lat, lng]
            let locBCorrected = [locB[0], locB[1]];
    
            // Add a polyline between two IP locations
            L.polyline([locACorrected, locBCorrected], {
                color: "#818589",
                weight: 2,
                dashArray: "5, 3"
            }).addTo(convMap);
    
            // Avoid duplicate markers
            let keyA = locACorrected.join(",");
            let keyB = locBCorrected.join(",");
    
            if (!uniqueLocations.has(keyA)) {
                uniqueLocations.add(keyA);
                let markerA = L.circleMarker(locACorrected, {
                    radius: 6,
                    fillColor: "#16DB93",
                    color: "#ffffff",
                    weight: 2,
                    fillOpacity: 1
                }).bindPopup(`
                    <strong>IP:</strong> ${conv["IP A"]} <br>
                    <strong>Country:</strong> ${conv["IP A Country"]} <br>
                    <strong>Packets:</strong> ${conv["Packets"]} <br>
                    <strong>Protocol:</strong> ${conv["Protocol"]}
                `);
                markers.addLayer(markerA); // Add to cluster group
            }
    
            if (!uniqueLocations.has(keyB)) {
                uniqueLocations.add(keyB);
                let markerB = L.circleMarker(locBCorrected, {
                    radius: 6,
                    fillColor: "#2C699A",
                    color: "#ffffff",
                    weight: 2,
                    fillOpacity: 1
                }).bindPopup(`
                    <strong>IP:</strong> ${conv["IP B"]} <br>
                    <strong>Country:</strong> ${conv["IP B Country"]} <br>
                    <strong>Packets:</strong> ${conv["Packets"]} <br>
                    <strong>Protocol:</strong> ${conv["Protocol"]}
                `);
                markers.addLayer(markerB); // Add to cluster group
            }
        } else {
            console.warn("Skipping entry due to missing location data:", conv);
        }
    });
    
    // Add clustered markers to the convMap
    convMap.addLayer(markers);

    // Store the initial view
    const initialConvView = {
        center: convMap.getCenter(),
        zoom: convMap.getZoom()
    };

    // Reset map button functionality
    document.getElementById('resetConvMap').addEventListener('click', function() {
        convMap.setView(initialConvView.center, initialConvView.zoom);
    });
    
    </script>
    